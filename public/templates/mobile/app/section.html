<screen-podbor-mobile class="section" data-active="false" data-overlay="false" data-visible="false" data-animate="true" is-animate="false" data-hidden="false">

    <!-- <offer-manager></offer-manager> -->

    <section-control-mobile></section-control-mobile>

    <section-menu-mobile></section-menu-mobile>

    <div class="section__content">

        <section-navbar-mobile></section-navbar-mobile>

        <div class="content">
            <div class="rows">
                <div class="row">
                    <product-item-mobile name="ledribbon" item={ $Cursor.ledribbon }></product-item-mobile>
                    <product-item-mobile name="power" item={ $Cursor.power }></product-item-mobile>
                    <product-item-mobile name="control" item={ $Cursor.control }></product-item-mobile>
                    <div class="search__empty">
                        <div class="search__empty__text">К сожалению компоненты не найдены, измените условия поиска, длину или тип освещения.</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <section-products-list-mobile></section-products-list-mobile>

    <section-product-mobile></section-product-mobile>

    <section-result-count></section-result-count>

    <div class="section__overlay"></div>

<script>

    var $ = this,
    $scope = $$(this.root);

    $.active = false;

    $.tooltipScreen = null;

    $.on("before-mount", function(){

        $Navbar = $.tags["section-navbar-mobile"];
        $Menu = $.tags["section-menu-mobile"];

        $Control = $.tags["section-control-mobile"];
        $Control.wrapper = $Control.tags["control-wrapper"];
        $Control.light = $Control.wrapper.tags["control-light"];
        $Control.humidity = $Control.wrapper.tags["control-humidity"];
        $Control.color = $Control.wrapper.tags["control-color"];
        $Control.length = $Control.wrapper.tags["control-length"];

        $Control.refresh = {
            humidity: function(){
                $Options.set('hum', $Cursor.ledribbon.get("product", "hum"));
            },
            color: function(){
                $Options.set('color', $Cursor.ledribbon.get("product", "color"));
            }
        };

        $Product = {
            "ledribbon": $["ledribbon"]._tag,
            "power": $["power"]._tag,
            "control": $["control"]._tag
        };

        $Cursor = {
            ledribbon: $store.data.getProductCursor("ledribbon"),
            power: $store.data.getProductCursor("power"),
            control: $store.data.getProductCursor("control")
        };

        $.sections = {
            resultCount: $.tags["section-result-count"],
            product: $.tags["section-product-mobile"],
            productsList: $.tags["section-products-list-mobile"]
        };
    });

    $.show = function(){
        $Screens.self.trigger("steps-hidden");
        $.root.setAttribute("data-visible", true);

        $.render();

        $.root.setAttribute("data-animate", false);
        $.root.setAttribute("data-active", true);
        $Router.params.set($State.get());

        $.active = true;
    };

    $.on("mode", function(mode, active){
        $.root.setAttribute("data-" + mode, active);
    });

    $.render = function(){
        var group = $State.get("group"),
            options = {
                "active": true,
                "light": $Options.get("light"),
                "length": $Options.get("length")
            };

        // get package with url
        var pkg = $Options.get("package") ?
            $store.packages.getItemById(
                $Options.get("package"), options
            ) : false;

        if (pkg){
            $State.select("group").set(pkg.group);
            $.set.productsAll(options);
            $.set.products({
                "ledribbon": pkg.ledribbon,
                "power": pkg.power,
                "control": pkg.control
            });
        }
        else {
            $.set.productsAll(options);
            options.group = group;

            // find first package with options
            pkg = _.sortArray(
                $store.packages.getItemsByParams(options)
            , "pos")[0];

            if (pkg){
                $State.select("group").set(pkg.group);
                $Options.select("package").set(pkg._id);
                $.set.products(pkg);
            }
            // other take the first of the list
            else {
                group = "norm";
                $Options.select("package").set();
                $.set.products({
                    "ledribbon": $Cursor.ledribbon.get("products", {"group": group}),
                    "power": $Cursor.power.get("products", {"group": group}),
                    "control": $Cursor.control.get("products", {"group": group})
                });
            }
        }

        $store.humidity.setStore();
        $Control.refresh.humidity();

        $store.color.setStore();
        $Control.refresh.color();

        $.set.totalPrice();

        $.update();
    };

    $.set = {
        params: function(){
            $Router.params.set($Options.get());
        },
        products: function(data){
            if (!data) return;

            $store.data.setProducts({
                "ledribbon": data.ledribbon && data.ledribbon.article ? data.ledribbon.article : data.ledribbon,
                "power": data.power && data.power.article ? data.power.article : data.power,
                "control": data.control && data.control.article ? data.control.article : data.control,
            });
        },
        productsAll: function(options){
            if (!options) return;

            $store.data.setProductsAll({
                "ledribbon": _.sortArray($store.products.getItemsByParamsWithoutGroup(
                    _.extend(options, {"type": "ledribbon"})
                ), "pos"),
                "power": _.sortArray($store.products.getItemsByParamsWithoutGroup(
                    _.extend(options, {"type": "power"})
                ), "pos"),
                "control": _.sortArray($store.products.getItemsByParamsWithoutGroup(
                    _.extend(options, {"type": "control"})
                ), "pos")
            });
        },
        totalPrice: function(){
            if (app.device.isPhone){
                $.sections.resultCount.update();
            }
            else {
                var result = 0,
                    products = {
                        ledribbon: $Cursor.ledribbon.get("product", "price"),
                        power: $Cursor.power.get("product", "price"),
                        control: $Options.get("controlled") ? $Cursor.control.get("product", "price") : null
                    };

                result += products.ledribbon ? products.ledribbon * $Options.get("length") : 0;
                result += products.power ? products.power : 0;
                result += products.control ? products.control : 0;

                $.sections.totalPrice.refresh(result);
                $Menu.totalPrice.refresh(result);
            }
        }
    };

    var setParams = _.debounce($.set.params, 300),
        reRender = _.debounce($.render, 300);

    $Options.on("write", function(e){
        var prop = e.data.path[0];

        if (prop == "controlled"){
            $Product["control"].update();
        }
        else if (prop == "light" || prop == "length"){
            reRender();
        }
        else if (prop == "hum"){
            $Control.humidity.update();
        }
        else if (prop == "color"){
            $Control.color.update();
        }
        if ($.active){
            setParams();
            if (prop != "length") $.set.totalPrice();
        }
    });

    _.bbUpdate($store.data, function(prop, value, e){
        if ($.active){
            if (value){
                if (value.type == "ledribbon"){
                    $Product["ledribbon"].update();
                }
                else if (value.type == "power"){
                    $Product["power"].update();
                }
                else if (value.type == "control"){
                    $Product["control"].update();
                }
            }
            $.set.totalPrice();
        }
    });

</script>

</screen-podbor-mobile>
