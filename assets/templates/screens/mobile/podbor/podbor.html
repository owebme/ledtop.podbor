<screen-podbor-mobile class="section" data-active="false" data-overlay="false" data-visible={ !hidden } data-animate="true" is-animate="false" data-hidden="false">

    <!-- <offer-manager></offer-manager> -->

    <section-control-mobile></section-control-mobile>

    <section-menu-mobile></section-menu-mobile>

    <div class="section__content">

        <section-navbar-mobile></section-navbar-mobile>

        <div class="content">
            <div class="rows">
                <div class="row">
                    <product-item-mobile name="ledribbon" item={ $Data.getProduct('ledribbon') }></product-item-mobile>
                    <product-item-mobile name="power-supply" item={ $Data.getProduct('power-supply') }></product-item-mobile>
                    <product-item-mobile name="ir-control" item={ $Data.getProduct('ir-control') }></product-item-mobile>
                </div>
            </div>
        </div>
    </div>

    <section-products-list-mobile></section-products-list-mobile>

    <section-result-count></section-result-count>

    <div class="section__overlay"></div>

<script>

    var $ = this,
    $scope = $$(this.root);

    $.active = false;
    $.hidden = true;

    $.tooltipScreen = null;

    $.show = function(animate){
        $Screens.self.trigger("steps-hidden");
        $.hidden = false;

        $.update();

        $.root.setAttribute("data-animate", false);
        $.root.setAttribute("data-active", true);
        $Router.params.set($State.get());
    };

    $.open = {
        tutorial: function(){
            $Tutorial.show($scope, "podbor");
            $Config.set('tutorial', false);
        }
    };

    $.on("overlay", function(active){
        $.root.setAttribute("data-overlay", active);
    });

    $.on("hidden", function(active){
        $.root.setAttribute("data-hidden", active);
    });

    $.on("before-mount", function(){

        $Navbar = $.tags["section-navbar-mobile"];
        $Menu = $.tags["section-menu-mobile"];

        $.sections = {
            resultCount: $.tags["section-result-count"],
            productsList: $.tags["section-products-list-mobile"]
        };

        $Control = $.tags["section-control-mobile"];
        $Control.wrapper = $Control.tags["control-wrapper"];
        $Control.light = $Control.wrapper.tags["control-light"];
        $Control.humidity = $Control.wrapper.tags["control-humidity"];
        $Control.color = $Control.wrapper.tags["control-color"];
        $Control.length = $Control.wrapper.tags["control-length"];

        $Product = {
            "ledribbon": $["ledribbon"]._tag,
            "power-supply": $["power-supply"]._tag,
            "ir-control": $["ir-control"]._tag
        };

        $.setParams = function(){
            $Router.params.set($State.get());
        };

        var setParams = _.debounce($.setParams, 100);

        $State.on("update", function(e){
            var data = $.getPropValue(e),
                prop = data.prop,
                value = data.value;

            if (prop){
                if (prop == "control"){
                    $Product["ir-control"].update();
                }
            }
            if ($.active) setParams();
        });

        $.reRender();
    });

    $.getFirstProduct = function(name){
        var item = $store[name].get()[0];
        item.pack = "norm";
        return item;
    };

    $.getProducts = function(name){
        var array = [];
            packs = ['econom', 'norm', 'lux'];

        for(var i=0; i < packs.length; i++){
            var arr = [];
            arr = _.copyArray($store[name].get()).map(function(item, j){
                item.pack = packs[i];
                if (packs[i] == "econom" || packs[i] == "lux"){
                    item.article = $.store[name][packs[i]][j];
                    item.photo = "http://ledtop-shop.ru/files/catalog/" + item.article + ".jpg";
                }
                return item;
            });
            array = array.concat(arr);
        }
        return array;
    };

    $.store = {
        ledribbon: {
            econom: ['010523', '020692'],
            lux: ['013393', '014676']
        },
        power: {
            econom: ['017831', '012919', '008889', '010505'],
            lux: ['017855', '015992', '011895', '018308']
        },
        control: {
            econom: ['012987', '021098', '015422', '020170', '011439'],
            lux: ['016678', '016476', '018609', '016927', '021025']
        }
    };

    $.reRender = function(){
        var data = [
            {
                _id: "ledribbon",
                title: "Лента",
                product: $.getFirstProduct("ledribbon"),
                products: $.getProducts("ledribbon")
            },
            {
                _id: "power-supply",
                title: "Блок питания",
                product: $.getFirstProduct("power"),
                products: $.getProducts("power")
            },
            {
                _id: "ir-control",
                title: "Управление",
                product: $.getFirstProduct("control"),
                products: $.getProducts("control")
            }
        ];

        $Data = _.extend(new Baobab(data),
            {
                getProduct: function(id){
                    return $Data.select({"_id": id});
                },
                getProductsList: function(id, pack){
                    return _.where($Data.select({"_id": id}).get("products"), {"pack": pack});
                },
                getProductsCount: function(id){
                    var count = $Data.select({"_id": id}).get("products");
                    return count ? count.length : 0;
                }
            }
        );
    };

    $.getPropValue = function(e){
        var prop = e.data && e.data.transaction && e.data.transaction.length && e.data.transaction[0].path ? e.data.transaction[0].path[0] : null,
            value = e.data && e.data.transaction && e.data.transaction.length ? e.data.transaction[0].value : null;

        return {
            prop: prop,
            value: value
        }
    };

</script>

</screen-podbor-mobile>
